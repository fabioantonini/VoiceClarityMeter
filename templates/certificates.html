<!DOCTYPE html>
<html lang="it">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Gestione Certificati TLS - VoIP Quality Monitor</title>
    <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.1.3/dist/css/bootstrap.min.css" rel="stylesheet">
    <link href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.0.0/css/all.min.css" rel="stylesheet">
    <link href="/static/css/style.css" rel="stylesheet">
</head>
<body>
    <nav class="navbar navbar-dark bg-primary">
        <div class="container-fluid">
            <a class="navbar-brand" href="/">
                <i class="fas fa-shield-alt me-2"></i>
                VoIP Quality Monitor - Certificati TLS
            </a>
            <div class="navbar-nav flex-row">
                <a class="nav-link me-3" href="/dashboard">
                    <i class="fas fa-chart-line me-1"></i>Dashboard
                </a>
                <a class="nav-link me-3" href="/config">
                    <i class="fas fa-cog me-1"></i>Configurazione
                </a>
                <a class="nav-link" href="/">
                    <i class="fas fa-home me-1"></i>Home
                </a>
            </div>
        </div>
    </nav>

    <div class="container-fluid mt-4">
        <!-- Status and Actions Row -->
        <div class="row mb-4">
            <div class="col-md-8">
                <div class="card">
                    <div class="card-header d-flex justify-content-between align-items-center">
                        <h5 class="mb-0">
                            <i class="fas fa-certificate me-2"></i>
                            Gestione Certificati TLS
                        </h5>
                        <span class="badge bg-info" id="tlsStatus">TLS: Configurazione Richiesta</span>
                    </div>
                    <div class="card-body">
                        <div class="alert alert-info" role="alert">
                            <i class="fas fa-info-circle me-2"></i>
                            <strong>Configurazione TLS per SIP:</strong> Genera certificati per abilitare SIP over TLS (SIPS) su porta 5061.
                            I certificati verranno scaricati e installati manualmente sui client SIP.
                        </div>
                        
                        <div class="row">
                            <div class="col-md-6">
                                <h6 class="fw-bold">Genera Nuovi Certificati</h6>
                                <form id="generateCertForm">
                                    <div class="mb-3">
                                        <label class="form-label">Nome Server</label>
                                        <input type="text" class="form-control" id="serverName" value="sip-server.local" required>
                                        <div class="form-text">Nome del server SIP (FQDN o hostname)</div>
                                    </div>
                                    <div class="mb-3">
                                        <label class="form-label">IP Server</label>
                                        <input type="text" class="form-control" id="serverIp" placeholder="Auto-rilevato">
                                        <div class="form-text">Lascia vuoto per auto-rilevamento</div>
                                    </div>
                                    <div class="mb-3">
                                        <label class="form-label">Organizzazione</label>
                                        <input type="text" class="form-control" id="organization" value="VoIP Monitor">
                                    </div>
                                    <div class="mb-3">
                                        <label class="form-label">Validità (giorni)</label>
                                        <select class="form-select" id="validityDays">
                                            <option value="365">1 Anno</option>
                                            <option value="730">2 Anni</option>
                                            <option value="1095">3 Anni</option>
                                        </select>
                                    </div>
                                    <button type="submit" class="btn btn-primary">
                                        <i class="fas fa-plus me-2"></i>Genera Certificati
                                    </button>
                                </form>
                            </div>
                            
                            <div class="col-md-6">
                                <h6 class="fw-bold">Genera Certificato Client</h6>
                                <form id="generateClientCertForm">
                                    <div class="mb-3">
                                        <label class="form-label">Nome Client</label>
                                        <input type="text" class="form-control" id="clientName" value="sip-client" required>
                                    </div>
                                    <div class="mb-3">
                                        <label class="form-label">Estensione</label>
                                        <input type="text" class="form-control" id="extension" placeholder="201" required>
                                        <div class="form-text">Numero interno per questo client</div>
                                    </div>
                                    <div class="mb-3">
                                        <label class="form-label">Validità (giorni)</label>
                                        <select class="form-select" id="clientValidityDays">
                                            <option value="365">1 Anno</option>
                                            <option value="730">2 Anni</option>
                                        </select>
                                    </div>
                                    <button type="submit" class="btn btn-success">
                                        <i class="fas fa-user-plus me-2"></i>Genera Certificato Client
                                    </button>
                                </form>
                            </div>
                        </div>
                    </div>
                </div>
            </div>
            
            <!-- Quick Info -->
            <div class="col-md-4">
                <div class="card">
                    <div class="card-header">
                        <h6 class="mb-0">
                            <i class="fas fa-info-circle me-2"></i>
                            Informazioni TLS
                        </h6>
                    </div>
                    <div class="card-body">
                        <div class="mb-3">
                            <small class="text-muted">Porta SIP TLS</small>
                            <div class="fw-bold">5061</div>
                        </div>
                        <div class="mb-3">
                            <small class="text-muted">Protocollo</small>
                            <div class="fw-bold">SIPS (SIP over TLS)</div>
                        </div>
                        <div class="mb-3">
                            <small class="text-muted">Crittografia</small>
                            <div class="fw-bold">TLS 1.2+</div>
                        </div>
                        <div class="mb-0">
                            <small class="text-muted">Certificati Attivi</small>
                            <div class="fw-bold" id="activeCerts">0</div>
                        </div>
                    </div>
                </div>
            </div>
        </div>

        <!-- Certificates List -->
        <div class="row">
            <div class="col-12">
                <div class="card">
                    <div class="card-header d-flex justify-content-between align-items-center">
                        <h5 class="mb-0">
                            <i class="fas fa-list me-2"></i>
                            Certificati Generati
                        </h5>
                        <button class="btn btn-outline-secondary btn-sm" onclick="refreshCertificates()">
                            <i class="fas fa-sync-alt me-1"></i>Aggiorna
                        </button>
                    </div>
                    <div class="card-body">
                        <div class="table-responsive">
                            <table class="table table-striped" id="certificatesTable">
                                <thead>
                                    <tr>
                                        <th>Nome File</th>
                                        <th>Tipo</th>
                                        <th>Soggetto</th>
                                        <th>Validità</th>
                                        <th>Scadenza</th>
                                        <th>Stato</th>
                                        <th>Azioni</th>
                                    </tr>
                                </thead>
                                <tbody id="certificatesTableBody">
                                    <tr>
                                        <td colspan="7" class="text-center text-muted">
                                            Nessun certificato trovato
                                        </td>
                                    </tr>
                                </tbody>
                            </table>
                        </div>
                    </div>
                </div>
            </div>
        </div>

        <!-- Configuration Instructions -->
        <div class="row mt-4">
            <div class="col-12">
                <div class="card">
                    <div class="card-header">
                        <h5 class="mb-0">
                            <i class="fas fa-book me-2"></i>
                            Istruzioni di Configurazione
                        </h5>
                    </div>
                    <div class="card-body">
                        <div class="row">
                            <div class="col-md-6">
                                <h6 class="fw-bold">Client SIP (X-Lite, Bria, etc.)</h6>
                                <ol class="small">
                                    <li>Scarica il <strong>bundle</strong> del certificato server</li>
                                    <li>Installa il certificato nelle autorità di certificazione del sistema</li>
                                    <li>Configura il client SIP:
                                        <ul>
                                            <li>Protocollo: <code>TLS</code></li>
                                            <li>Server: <code id="serverNameDisplay">sip-server.local</code></li>
                                            <li>Porta: <code>5061</code></li>
                                            <li>URI: <code>sips:201@server:5061</code></li>
                                        </ul>
                                    </li>
                                </ol>
                            </div>
                            
                            <div class="col-md-6">
                                <h6 class="fw-bold">Gateway Asterisk</h6>
                                <ol class="small">
                                    <li>Carica certificati server su Asterisk</li>
                                    <li>Modifica <code>sip.conf</code> o <code>pjsip.conf</code>:
                                        <pre class="bg-light p-2 small"><code>[transport-tls]
type=transport
protocol=tls
bind=0.0.0.0:5061
cert_file=/path/to/server-cert.pem
priv_key_file=/path/to/server-key.pem
ca_list_file=/path/to/ca-cert.pem</code></pre>
                                    </li>
                                    <li>Riavvia Asterisk</li>
                                </ol>
                            </div>
                        </div>
                        
                        <div class="alert alert-warning mt-3" role="alert">
                            <i class="fas fa-exclamation-triangle me-2"></i>
                            <strong>Attenzione:</strong> I certificati auto-firmati genereranno avvisi di sicurezza sui client.
                            Per produzione, considera l'uso di certificati firmati da CA riconosciute.
                        </div>
                    </div>
                </div>
            </div>
        </div>
    </div>

    <!-- Progress Modal -->
    <div class="modal fade" id="progressModal" tabindex="-1" aria-hidden="true">
        <div class="modal-dialog">
            <div class="modal-content">
                <div class="modal-body text-center p-4">
                    <div class="spinner-border text-primary mb-3" role="status">
                        <span class="visually-hidden">Loading...</span>
                    </div>
                    <div id="progressText">Generazione certificati in corso...</div>
                </div>
            </div>
        </div>
    </div>

    <script src="https://code.jquery.com/jquery-3.6.0.min.js"></script>
    <script src="https://cdn.jsdelivr.net/npm/bootstrap@5.1.3/dist/js/bootstrap.bundle.min.js"></script>
    <script src="/static/js/certificates.js"></script>
</body>
</html>